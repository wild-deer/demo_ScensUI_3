import{r as i,c as R,a as d,b as l,n as j,d as D,e as le,t as V,u as te,o as f}from"./index-DcoPBRTl.js";import{d as se}from"./index-UcaH2mKL.js";const ae={class:"flex flex-col h-screen w-screen text-white inset-0 m-0 p-0 overflow-hidden bg-cover bg-center"},oe={class:"flex flex-1 p-4 gap-4"},ne={class:"w-80 max-w-[28rem] flex-shrink-0 rounded-lg border border-gray-200 bg-gray-100 p-4 text-slate-900"},ie={class:"flex gap-2 mb-4 pb-4"},re={key:0,class:"space-y-4"},ue={key:1,class:"space-y-4"},ce={class:"mt-6 pt-10"},de={key:0,class:"mt-4 space-y-2"},fe={key:0},me={class:"font-mono"},ve=["href","download"],be={key:1},ge=["href","download"],pe={class:"pt-10"},xe=["disabled"],he={class:"flex-1 rounded-lg border border-gray-200 bg-gray-100 overflow-hidden grid place-items-center"},ye=["src"],_e={__name:"Gdwytj",setup(we){const K=te(),u=i("surface"),O=i(null),G=i(null),E=i(null),H=i(null),$=i(null),b=i("idle"),y=i({value:null,fileUrl:"",fileName:"surface_result.tif"}),k=i(""),g=i("idle"),p=i({value:null,fileUrl:"",fileName:"volume_result.json"}),S=i(""),z=R(()=>w.value==="running"?"正在计算":w.value==="done"?"重新计算":"开始计算"),A=async s=>{try{const e=await s.arrayBuffer(),t=se(e);if(!t||t.length===0)return"";const a=t[0],{width:n,height:x,data:o}=a,M=n*x,C=o.length/M,_=document.createElement("canvas");_.width=n,_.height=x;const P=_.getContext("2d"),I=P.createImageData(n,x),m=I.data;if(C===1){let c=1/0,v=-1/0;for(let r=0;r<o.length;r++)o[r]<c&&(c=o[r]),o[r]>v&&(v=o[r]);const h=v-c||1;for(let r=0;r<M;r++){const ee=o[r],N=Math.floor((ee-c)/h*255),U=r*4;m[U]=N,m[U+1]=N,m[U+2]=N,m[U+3]=255}}else if(C>=3)for(let c=0;c<M;c++){const v=c*C,h=c*4;m[h]=o[v],m[h+1]=o[v+1],m[h+2]=o[v+2],m[h+3]=C>3?o[v+3]:255}return P.putImageData(I,0,0),_.toDataURL("image/png")}catch(e){return console.error("TIFF render error:",e),""}},T=async()=>{b.value="running",await new Promise(n=>setTimeout(n,1200));const s="surface_result.tif",e=E.value||new Blob(["DEM"],{type:"application/octet-stream"}),t=URL.createObjectURL(e);y.value={value:null,fileUrl:t,fileName:s};const a=await A(e);a?k.value=a:k.value=L("surface",null),b.value="done"},B=()=>{g.value="running",setTimeout(()=>{const s=Math.round(Math.random()*1e5)/10,e="volume_result.json",t=new Blob([JSON.stringify({volume:s})],{type:"application/json"}),a=URL.createObjectURL(t);p.value={value:s,fileUrl:a,fileName:e},S.value=L("volume",s),g.value="done"},1200)},J=()=>{K.push({name:"home"})},W=s=>{O.value=s.target.files},q=s=>{var e;G.value=((e=s.target.files)==null?void 0:e[0])??null},Q=s=>{var e;E.value=((e=s.target.files)==null?void 0:e[0])??null},X=s=>{var e;H.value=((e=s.target.files)==null?void 0:e[0])??null},Y=s=>{var e;$.value=((e=s.target.files)==null?void 0:e[0])??null},Z=()=>{u.value==="surface"?b.value==="idle"?T():b.value==="done"&&(b.value="idle",y.value={value:null,fileUrl:"",fileName:"surface_result.tif"},k.value="",T()):g.value==="idle"?B():g.value==="done"&&(g.value="idle",p.value={value:null,fileUrl:"",fileName:"volume_result.json"},S.value="",B())},w=R(()=>u.value==="surface"?b.value:g.value),F=R(()=>u.value==="surface"?k.value:S.value),L=(s,e)=>{const t=document.createElement("canvas");t.width=640,t.height=360;const a=t.getContext("2d"),n=a.createLinearGradient(0,0,t.width,t.height);if(s==="surface")n.addColorStop(0,"#1e3a8a"),n.addColorStop(1,"#93c5fd"),a.fillStyle=n,a.fillRect(0,0,t.width,t.height);else{n.addColorStop(0,"#065f46"),n.addColorStop(1,"#34d399"),a.fillStyle=n,a.fillRect(0,0,t.width,t.height);const x=60,o=Math.min(300,Math.max(20,(e||0)/500));a.fillStyle="#064e3b",a.fillRect(t.width/2-x/2,t.height-o-20,x,o)}return t.toDataURL("image/png")};return(s,e)=>(f(),d("div",ae,[l("header",{class:"flex items-center px-5"},[l("button",{onClick:J,class:"mr-4 bg-gray-100 text-slate-900 hover:bg-gray-300 h-full grid place-items-center rounded-l-lg","aria-label":"返回主页"},[...e[2]||(e[2]=[l("div",{class:"px-4 text-2xl"},"返回",-1)])]),e[3]||(e[3]=l("div",{class:"flex-1 text-center bg-gray-100 text-black py-6 px-10 rounded-r-lg text-3xl font-bold tracking-wide select-none"}," 沟道物源体积 ",-1))]),l("div",oe,[l("aside",ne,[l("div",ie,[l("button",{onClick:e[0]||(e[0]=t=>u.value="surface"),class:j(u.value==="surface"?"px-3 py-2 rounded-md bg-blue-600 text-white":"px-3 py-2 rounded-md bg-gray-200 text-slate-900 hover:bg-gray-300")}," 底面构建 ",2),l("button",{onClick:e[1]||(e[1]=t=>u.value="volume"),class:j(u.value==="volume"?"px-3 py-2 rounded-md bg-blue-600 text-white":"px-3 py-2 rounded-md bg-gray-200 text-slate-900 hover:bg-gray-300")}," 体积计算 ",2)]),e[12]||(e[12]=l("div",{class:"mb-3 text-lg font-bold text-slate-700 pb-4"},"输入文件:",-1)),u.value==="surface"?(f(),d("div",re,[l("div",null,[e[4]||(e[4]=l("label",{class:"block text-sm mb-2 text-slate-700"},"Shapefile（可多选 .shp/.shx/.dbf/.prj）",-1)),l("input",{type:"file",multiple:"",accept:".shp,.shx,.dbf,.prj",class:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700",onChange:W},null,32)]),l("div",null,[e[5]||(e[5]=l("label",{class:"block text-sm mb-2 text-slate-700"},"KML",-1)),l("input",{type:"file",accept:".kml",class:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700",onChange:q},null,32)]),l("div",null,[e[6]||(e[6]=l("label",{class:"block text-sm mb-2 text-slate-700"},"DEM（输入）",-1)),l("input",{type:"file",accept:".tif,.dem,.asc",class:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700",onChange:Q},null,32)])])):(f(),d("div",ue,[l("div",null,[e[7]||(e[7]=l("label",{class:"block text-sm mb-2 text-slate-700"},"DEM1",-1)),l("input",{type:"file",accept:".tif,.dem,.asc",class:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700",onChange:X},null,32)]),l("div",null,[e[8]||(e[8]=l("label",{class:"block text-sm mb-2 text-slate-700"},"DEM2",-1)),l("input",{type:"file",accept:".tif,.dem,.asc",class:"block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700",onChange:Y},null,32)])])),l("div",ce,[e[11]||(e[11]=l("div",{class:"mb-3 text-lg font-bold text-slate-700 py-4"},"输出文件:",-1)),w.value==="done"?(f(),d("div",de,[u.value==="volume"?(f(),d("div",fe,[l("div",null,[e[9]||(e[9]=le("体积结果：",-1)),l("span",me,V(p.value.value),1)]),p.value.fileUrl?(f(),d("a",{key:0,href:p.value.fileUrl,download:p.value.fileName,class:"inline-block px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700"}," 下载结果文件 ",8,ve)):D("",!0)])):(f(),d("div",be,[e[10]||(e[10]=l("div",null,"已生成 DEM 文件",-1)),y.value.fileUrl?(f(),d("a",{key:0,href:y.value.fileUrl,download:y.value.fileName,class:"inline-block px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700"}," 下载 DEM ",8,ge)):D("",!0)]))])):D("",!0)]),l("div",pe,[l("button",{class:j(["w-full py-2 rounded-md transition",w.value==="running"?"bg-gray-400 text-white cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700 active:scale-[.99]"]),disabled:w.value==="running",onClick:Z},V(z.value),11,xe)])]),l("main",he,[F.value?(f(),d("img",{key:0,src:F.value,class:"max-w-full max-h-full object-contain"},null,8,ye)):D("",!0)])])]))}};export{_e as default};
